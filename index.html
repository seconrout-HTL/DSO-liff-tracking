<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Tracking & Dashboard</title>
    <script charset="utf-8" src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;500;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Sarabun', sans-serif; background-color: #F3F4F6; }
        .hidden-page { display: none; }
        .active-tab { color: #2563EB; border-bottom: 3px solid #2563EB; }
        .status-line { position: absolute; left: 19px; top: 25px; bottom: 0; width: 2px; background: #E5E7EB; z-index: 0; }
        .status-dot { z-index: 10; position: relative; }
        .skeleton { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; background: #E5E7EB; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: .5; } }
    </style>
</head>
<body class="pb-20">

    <header class="bg-white shadow-sm sticky top-0 z-50">
        <div class="px-4 py-4 flex justify-between items-center">
            <div>
                <h1 class="text-xl font-bold text-gray-800">ระบบติดตามงาน</h1>
                <p id="user-display" class="text-xs text-gray-500">Guest User</p>
            </div>
            <button onclick="fetchData()" class="text-blue-600 hover:bg-blue-50 p-2 rounded-full transition">
                <i class="fas fa-sync-alt"></i>
            </button>
        </div>
        
        <div class="flex text-center bg-white mt-2">
            <div onclick="switchTab('tracking')" id="tab-tracking" class="flex-1 py-3 text-sm font-bold text-gray-500 cursor-pointer active-tab transition">
                รายการล่าสุด
            </div>
            <div onclick="switchTab('dashboard')" id="tab-dashboard" class="flex-1 py-3 text-sm font-bold text-gray-500 cursor-pointer transition">
                ภาพรวมวันนี้
            </div>
        </div>
    </header>

    <div id="page-tracking" class="p-4 space-y-4">
        <div class="relative">
            <input type="text" id="search-input" onkeyup="filterList()" placeholder="ค้นหาเลข DO หรือ สาขา..." class="w-full pl-10 pr-4 py-3 rounded-xl border-none shadow-sm focus:ring-2 focus:ring-blue-500 outline-none">
            <i class="fas fa-search absolute left-4 top-3.5 text-gray-400"></i>
        </div>

        <div id="loading" class="space-y-3">
            <div class="h-32 bg-white rounded-xl shadow-sm p-4 skeleton"></div>
            <div class="h-32 bg-white rounded-xl shadow-sm p-4 skeleton"></div>
        </div>

        <div id="tracking-list" class="space-y-4 pb-10"></div>
    </div>

    <div id="page-dashboard" class="p-4 space-y-4 hidden-page">
        <div class="grid grid-cols-2 gap-4">
            <div class="bg-white p-4 rounded-xl shadow-sm text-center border-l-4 border-blue-500">
                <p class="text-xs text-gray-500">ยอดงานทั้งหมด</p>
                <h2 id="dash-total" class="text-3xl font-bold text-gray-800 mt-1">-</h2>
            </div>
            <div class="bg-white p-4 rounded-xl shadow-sm text-center border-l-4 border-orange-500">
                <p class="text-xs text-gray-500">รอจัดส่ง</p>
                <h2 id="dash-waiting" class="text-3xl font-bold text-orange-600 mt-1">-</h2>
            </div>
        </div>
        
        <div class="bg-gradient-to-r from-green-500 to-green-600 p-5 rounded-xl shadow-lg text-white flex justify-between items-center">
            <div>
                <p class="text-green-100 text-sm">จัดส่งสำเร็จแล้ว</p>
                <h2 id="dash-shipped" class="text-4xl font-bold mt-1">-</h2>
            </div>
            <i class="fas fa-shipping-fast text-5xl opacity-50"></i>
        </div>

        <div class="bg-white rounded-xl shadow-sm p-4">
            <h3 class="font-bold text-gray-700 mb-3"><i class="fas fa-chart-pie mr-2 text-blue-500"></i>สถานะล่าสุด</h3>
            <div id="latest-updates" class="space-y-3 text-sm">
                </div>
        </div>
    </div>

    <script>
        // ==========================================
        // ⚙️ ตั้งค่า: ใส่ URL Web App ของคุณที่นี่
        // ==========================================
        const GAS_API_URL = 'https://script.google.com/macros/s/xxxxxxxxx/exec'; 
        // ==========================================

        let globalData = [];

        // เริ่มต้นทำงาน
        window.onload = async function() {
            await initLiff();
            fetchData();
        };

        async function initLiff() {
            try {
                // ใส่ LIFF ID ของคุณ (ถ้ามี) ถ้าไม่มีก็รันได้บน Browser ปกติ
                // await liff.init({ liffId: "YOUR_LIFF_ID" });
                if (liff.isLoggedIn()) {
                    const profile = await liff.getProfile();
                    document.getElementById('user-display').innerText = `สวัสดี, ${profile.displayName}`;
                }
            } catch (err) {
                console.log('LIFF Init Error (Dev Mode):', err);
            }
        }

        function switchTab(tabName) {
            // Update Tab Style
            document.getElementById('tab-tracking').className = tabName === 'tracking' ? 'flex-1 py-3 text-sm font-bold text-blue-600 border-b-2 border-blue-600 cursor-pointer transition' : 'flex-1 py-3 text-sm font-bold text-gray-500 cursor-pointer transition';
            document.getElementById('tab-dashboard').className = tabName === 'dashboard' ? 'flex-1 py-3 text-sm font-bold text-blue-600 border-b-2 border-blue-600 cursor-pointer transition' : 'flex-1 py-3 text-sm font-bold text-gray-500 cursor-pointer transition';

            // Show/Hide Content
            document.getElementById('page-tracking').style.display = tabName === 'tracking' ? 'block' : 'none';
            document.getElementById('page-dashboard').style.display = tabName === 'dashboard' ? 'block' : 'none';
        }

        async function fetchData() {
            document.getElementById('loading').style.display = 'block';
            document.getElementById('tracking-list').innerHTML = '';

            try {
                const response = await fetch(`${GAS_API_URL}?action=getTrackingData`);
                const json = await response.json();
                
                if (json.status === 'success') {
                    globalData = json.data;
                    renderTrackingList(globalData);
                    updateDashboard(json.dashboard, json.data.slice(0, 5));
                }
            } catch (error) {
                alert('เกิดข้อผิดพลาดในการดึงข้อมูล: ' + error);
            } finally {
                document.getElementById('loading').style.display = 'none';
            }
        }

        function renderTrackingList(data) {
            const container = document.getElementById('tracking-list');
            container.innerHTML = '';

            if(data.length === 0) {
                container.innerHTML = '<div class="text-center text-gray-400 mt-10">ไม่พบข้อมูล</div>';
                return;
            }

            data.forEach(item => {
                // Determine Colors based on Progress
                const step1Color = item.progress >= 1 ? 'text-blue-500' : 'text-gray-300';
                const step2Color = item.progress >= 2 ? 'text-blue-500' : 'text-gray-300';
                const step3Color = item.progress >= 3 ? 'text-green-500' : 'text-gray-300';
                
                const card = `
                <div class="bg-white rounded-xl shadow-sm p-4 relative overflow-hidden">
                    <div class="flex justify-between items-start mb-3">
                        <div>
                            <span class="bg-gray-100 text-gray-600 text-xs px-2 py-1 rounded-md mb-1 inline-block">${item.targetDate}</span>
                            <h3 class="font-bold text-lg text-gray-800">${item.branch}</h3>
                            <p class="text-sm text-blue-600 font-bold">DO: ${item.doNumber}</p>
                        </div>
                        <div class="text-right">
                             <span class="text-xs text-gray-400">จำนวน</span>
                             <p class="font-bold text-gray-800">${item.amount}</p>
                        </div>
                    </div>
                    
                    <div class="flex justify-between items-center text-center relative mt-4">
                        <div class="absolute top-1/2 left-0 w-full h-1 bg-gray-100 -z-0"></div>
                        
                        <div class="bg-white px-2 z-10 flex flex-col items-center">
                            <i class="fas fa-file-invoice ${step1Color} text-lg mb-1"></i>
                            <span class="text-[10px] text-gray-500">เปิดบิล</span>
                            <span class="text-[10px] text-gray-400">${item.details.bill.time || '-'}</span>
                        </div>
                        
                        <div class="bg-white px-2 z-10 flex flex-col items-center">
                            <i class="fas fa-check-circle ${step2Color} text-lg mb-1"></i>
                            <span class="text-[10px] text-gray-500">ยืนยัน</span>
                            <span class="text-[10px] text-gray-400">${item.details.conf.time || '-'}</span>
                        </div>
                        
                        <div class="bg-white px-2 z-10 flex flex-col items-center">
                            <i class="fas fa-truck ${step3Color} text-lg mb-1"></i>
                            <span class="text-[10px] text-gray-500">จัดส่ง</span>
                            <span class="text-[10px] text-gray-400">${item.details.ship.time || '-'}</span>
                        </div>
                    </div>
                </div>`;
                container.insertAdjacentHTML('beforeend', card);
            });
        }

        function updateDashboard(summary, latestItems) {
            document.getElementById('dash-total').innerText = summary.total;
            document.getElementById('dash-waiting').innerText = summary.waiting;
            document.getElementById('dash-shipped').innerText = summary.shipped;

            const listDiv = document.getElementById('latest-updates');
            listDiv.innerHTML = '';
            latestItems.forEach(item => {
                let icon = item.progress === 3 ? '<i class="fas fa-check text-green-500"></i>' : '<i class="fas fa-clock text-orange-500"></i>';
                listDiv.insertAdjacentHTML('beforeend', `
                    <div class="flex justify-between items-center border-b border-gray-100 pb-2">
                        <div class="flex items-center gap-2">
                            ${icon}
                            <span class="text-gray-600">${item.branch} (${item.doNumber})</span>
                        </div>
                        <span class="text-xs text-gray-400">${item.details.bill.time}</span>
                    </div>
                `);
            });
        }

        function filterList() {
            const query = document.getElementById('search-input').value.toLowerCase();
            const filtered = globalData.filter(item => 
                item.doNumber.toLowerCase().includes(query) || 
                item.branch.toLowerCase().includes(query)
            );
            renderTrackingList(filtered);
        }
    </script>
</body>
</html>